ENV["RACK_ENV"] = "test"

gem "rspec", "~> 1.2.0"
gem "rack-test", ">= 0.4.0"
gem "webrat", ">= 0.5.0"

# Load app
app_file = File.join(File.dirname(__FILE__), *%w[.. .. app.rb])
require app_file

require "spec/expectations"
require "rack/test"
require "webrat"
require "sequel/extensions/migration"

# Webrat setup
Webrat.configure do |config|
  config.mode = :rack
end

# Set the Sinatra environment
<%= name %>::App.configure do |c|
  c.set     :environment, :test
  c.disable :run
  c.enable  :raise_errors
  c.disable :logging
end

class <%= name %>World
  include Rack::Test::Methods
  include Webrat::Methods
  include Webrat::Matchers
  
  Webrat::Methods.delegate_to_session :response
  
  def app
    <%= name %>::App
  end
end

# Cucumber world setup
World { <%= name %>World.new }

Before do
  Sequel::Model.db.tables.each do |table_name|
    Sequel::Model.db.drop_table table_name
  end
  dirname = File.join(File.dirname(__FILE__), "..", "..", "migrations")
  Sequel::Migrator.apply(Sequel::Model.db, dirname) if File.directory?(dirname)
end

After do
  Sequel::Model.db.tables.each do |table_name|
    Sequel::Model.db["TRUNCATE #{table_name}"]
  end
end